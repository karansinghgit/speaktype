name: Build and Release Mac App

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-14
    permissions:
      contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.swiftpm
        key: deps-${{ github.ref }}
        restore-keys: |
          deps-

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Install create-dmg
      run: brew install create-dmg

    - name: Reset Swift Package Dependencies
      run: |
        echo "ðŸ“¦ Resetting Swift Package Dependencies..."
        xcodebuild -resolvePackageDependencies

    - name: Build App (Scheme Method)
      run: |
        echo "ðŸ—ï¸ Building SpeakType using SCHEME..."
        xcodebuild -project "speaktype.xcodeproj" \
          -scheme "speaktype" \
          -configuration Release \
          -derivedDataPath build \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          clean build

    - name: Create DMG Background
      run: |
        if [ -f "dmg-assets/dmg-background.png" ]; then
          echo "âœ… DMG background already present"
          exit 0
        fi
        cd dmg-assets
        if [ -f "create-dmg-background.sh" ]; then
          chmod +x create-dmg-background.sh
          ./create-dmg-background.sh || echo "Using existing background"
        else
          echo "âš ï¸  No background generator script found; continuing"
        fi

    - name: Locate App & Create DMG
      run: |
        VERSION="${GITHUB_REF_NAME#v}"
        DMG_NAME="SpeakType-${VERSION}.dmg"
        # Find the app anywhere in the build folder
        APP_PATH=$(find build -name "speaktype.app" | head -n 1)

        if [ -z "$APP_PATH" ]; then
          echo "âŒ Error: Could not find speaktype.app!"
          exit 1
        fi
        
        echo "âœ… Found App at: $APP_PATH"

        # Create DMG with custom background
        # Create background if needed
        if [ ! -f "dmg-assets/dmg-background.png" ]; then
          cd dmg-assets
          python3 create-background.py 2>/dev/null || ./create-background.sh 2>/dev/null || echo "Using default"
          cd ..
        fi
        
        # Create DMG with arrow background
        # Note: If background image is missing, create-dmg typically warns but proceeds with default
        create-dmg \
          --volname "SpeakType" \
          --volicon "speaktype/Assets.xcassets/AppIcon.appiconset/icon_512x512.png" \
          --background "dmg-assets/dmg-background.png" \
          --window-pos 200 120 \
          --window-size 660 400 \
          --icon-size 160 \
          --icon "speaktype.app" 180 170 \
          --hide-extension "speaktype.app" \
          --app-drop-link 480 170 \
          "$DMG_NAME" \
          "$APP_PATH"

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        files: SpeakType-${{ github.ref_name }}.dmg
        generate_release_notes: true
