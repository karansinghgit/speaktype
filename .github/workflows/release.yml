name: Build and Release Mac App

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-14
    permissions:
      contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.swiftpm
        key: deps-${{ github.ref }}
        restore-keys: |
          deps-

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Install create-dmg
      run: brew install create-dmg

    - name: Reset Swift Package Dependencies
      run: |
        echo "üì¶ Resetting Swift Package Dependencies..."
        xcodebuild -resolvePackageDependencies

    - name: Build App (Scheme Method)
      run: |
        echo "üèóÔ∏è Building SpeakType using SCHEME..."
        xcodebuild -project "speaktype.xcodeproj" \
          -scheme "speaktype" \
          -configuration Release \
          -derivedDataPath build \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          clean build

    - name: Locate App & Create DMG
      run: |
        # Find the app in the build folder
        APP_PATH=$(find build -name "speaktype.app" | head -n 1)

        if [ -z "$APP_PATH" ]; then
          echo "‚ùå Error: Could not find speaktype.app!"
          exit 1
        fi
        
        echo "‚úÖ Found App at: $APP_PATH"

        # Create DMG
        create-dmg \
          --volname "SpeakType" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --hide-extension "speaktype.app" \
          --app-drop-link 600 185 \
          --no-internet-enable \
          "SpeakType.dmg" \
          "$APP_PATH"

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        files: SpeakType.dmg
        generate_release_notes: true
